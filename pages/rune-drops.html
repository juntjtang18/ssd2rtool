<!doctype html>
<!-- /pages/rune-drops.html -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSD2R Tool - Boss Rune Drop Rates</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e7eefc; --muted:#9db0d1;
      --accent:#65d2ff; --good:#8bffb1; --warn:#ffd38b; --bad:#ff8b8b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; background:linear-gradient(180deg,#070c16,var(--bg)); color:var(--text); font-family:var(--sans); }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    h1{ font-size:20px; margin:0 0 8px; }
    .sub{ color:var(--muted); font-size:12px; line-height:1.45; }
    .card{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06); border-radius:14px; padding:16px; box-shadow:0 12px 26px rgba(0,0,0,0.35); }

    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; }
    .ctrl{ min-width:220px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.22); color:var(--text); outline:none; }
    .checkline{ display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.18); color:var(--muted); font-size:12px; }
    .checkline input{ width:16px; height:16px; }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .tableWrap{ overflow:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.06); }
    table{ width:max-content; min-width:100%; border-collapse:separate; border-spacing:0; }
    th, td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,0.06); white-space:nowrap; }
    th{ text-align:left; font-size:12px; color:var(--muted); font-weight:900; position:sticky; top:0; background:rgba(7,12,22,0.92); backdrop-filter: blur(6px); z-index:3; }
    th.corner{ left:0; z-index:4; }
    td{ font-size:12px; }
    .mono{ font-family:var(--mono); }
    .num{ text-align:right; font-family:var(--mono); }

    td.sticky{ position:sticky; left:0; background:rgba(7,12,22,0.92); backdrop-filter: blur(6px); z-index:2; }
    tr:hover td{ color:var(--accent); }

    .runeBtn{ cursor:pointer; font-weight:900; }
    .runeBtn .hint{ font-weight:700; color:var(--muted); margin-left:8px; }

    .err{ font-size:12px; color:var(--bad); white-space:pre-wrap; }
    .pillbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.18); font-size:12px; color:var(--muted); }
    .pill strong{ color:var(--text); font-family:var(--mono); }

    .topbar{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .langbox{ display:flex; align-items:center; gap:8px; margin-top: 2px; }
    .langbox .globe{ font-size: 16px; opacity:.9; }
    .langbox select{ width: 140px; padding: 9px 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.22); color:var(--text); font-size: 14px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 data-i18n="h1">Boss Rune Drop Rates</h1>
        <div class="sub" data-i18n-html="sub">
          Table values are based on <span class="mono">expected drop count per kill</span> (not "chance of at least one").
          Click a rune name (left column) to sort bosses by that rune.
        </div>
      </div>

      <div class="langbox" data-i18n-title="lang.title">
        <span class="globe">üåê</span>
        <select id="langSel" data-i18n-aria-label="lang.aria">
          <option value="zh-Hant" data-i18n="lang.zhHant">ÁπÅÈ´î</option>
          <option value="zh-Hans" data-i18n="lang.zhHans">ÁÆÄ‰Ωì</option>
          <option value="en" data-i18n="lang.en">EN</option>
        </select>
      </div>
    </div>

    <div class="card" style="margin-top:14px; margin-bottom:16px;">
      <div class="controls">
        <div class="ctrl">
          <label data-i18n="ctrl.display">Display</label>
          <select id="fmtSel">
            <option value="perkill" data-i18n="opt.perkill">Per kill (scientific)</option>
            <option value="onein" data-i18n="opt.onein">1:N (DropCalc style)</option>
            <option value="per10k" data-i18n="opt.per10k">Per 10,000 kills</option>
            <option value="per1m" data-i18n="opt.per1m">Per 1,000,000 kills</option>
          </select>
        </div>

        <div class="ctrl" style="min-width:180px;">
          <label data-i18n="ctrl.precision">Precision</label>
          <select id="precSel">
            <option value="2" data-i18n="prec.compact">Compact</option>
            <option value="3" selected data-i18n="prec.normal">Normal</option>
            <option value="5" data-i18n="prec.detailed">Detailed</option>
          </select>
        </div>

        <div class="ctrl">
          <label data-i18n="ctrl.rows">Rows</label>
          <div class="checkline">
            <input id="showAll" type="checkbox" />
            <span data-i18n="ctrl.showAll">Show all runes from price table (otherwise: high runes only)</span>
          </div>
        </div>

        <!-- Boss-column filter: Council(11) is a multi-member pack and can skew comparisons; allow toggling it. -->
        <div class="ctrl">
          <label data-i18n="ctrl.bossCols">Boss columns</label>
          <div class="checkline">
            <input id="showCouncil11" type="checkbox" />
            <span data-i18n="ctrl.showCouncil11">Include Council (11) column</span>
          </div>
        </div>

        <div class="ctrl" style="min-width:260px;">
          <label data-i18n="ctrl.dataset">Dataset</label>
          <div class="pillbar" id="metaPills"></div>
        </div>
      </div>

      <div class="err" id="loadErr" style="display:none; margin-top:10px;"></div>
      <div class="sub" style="margin-top:10px;">
        <a href="../index.html" data-i18n="nav.back">&lt;- Back</a>
      </div>
    </div>

    <div class="card">
      <div class="tableWrap">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="sub" style="margin-top:10px;">
        <span data-i18n="tip.sort">Tip: when a rune is selected for sorting, bosses are reordered left-to-right by that rune's drop rate.</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { loadPriceTable, normRune } from "../model/priceTable.js";
    import { BOSSES, loadBossDropsByFileId, formatBossMeta } from "../model/rpk.js";
    import { detectLang, loadI18nJson, makeT, applyI18nToDom } from "../model/i18n.js";

    const el = (id) => document.getElementById(id);

    // i18n
    let dict = null;
    let t = (key, vars=null) => key;

    function applyLang(lang, { rerender = true } = {}) {
      localStorage.setItem("lang", lang);
      t = makeT(dict, lang);
      document.documentElement.lang = lang;
      document.title = t("title");
      applyI18nToDom(t);
      el("langSel").value = lang;
      if (rerender) render();
    }

    async function initI18n() {
      dict = await loadI18nJson("../i18n/rune-drops.json");
      const lang = detectLang();
      applyLang(lang, { rerender: false });
      el("langSel").addEventListener("change", () => applyLang(el("langSel").value));
    }

    const EXCLUDE = new Set(["PG","PA","FG","FA","UKEY"]);
    // Default view: high runes only (always include ZOD even if not priced).
    const HIGH_RUNE_ROWS = ["PUL", "UM", "MAL", "IST", "GUL", "VEX","OHM","LO","SUR","BER","JAH","CHAM","ZOD"];
    // When showing all runes, we keep a reasonable ordering but also include anything else we see.
    const PREFERRED_ORDER = ["EL","ELD","TIR","NEF","ETH","ITH","TAL","RAL","ORT","THUL","AMN","SOL","SHAEL","DOL","HEL","IO","LUM","KO","FAL","LEM","PUL","UM","MAL","IST","GUL","VEX","OHM","LO","SUR","BER","JAH","CHAM","ZOD"];

    let priceTable = null;
    let bossesDataAll = null; // all loaded boss datasets (including optional columns)
    let bossesData = null; // kept for backward-compat, but render now uses bossesDataAll

    // Boss-column toggles
    let includeCouncil11 = false; // default OFF to avoid mixing pack drops into single-boss comparison

    let showAll = false;
    // Default to DropCalc-style readability.
    let fmtMode = "onein"; // onein | perk... | per10k | per1m
    let precision = 3; // 2 (compact), 3 (normal), 5 (detailed)
    let sortRune = null;
    let sortDir = "desc";

    function setErr(msg) {
      const box = el("loadErr");
      if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
      box.style.display = "block";
      box.textContent = msg;
    }

    function buildRuneRows() {
      // If not showing all: always show the high-rune rows, regardless of pricing.
      if (!showAll) return [...HIGH_RUNE_ROWS];

      // Show-all: union all rune keys observed in boss drop datasets.
      const seen = new Set();
      for (const b of (bossesDataAll || [])) {
        const d = b?.data?.drops || {};
        for (const k of Object.keys(d)) {
          const rk = normRune(k);
          if (!rk || EXCLUDE.has(rk)) continue;
          // keep only rune-looking keys (letters only)
          if (!/^[A-Z]+$/.test(rk)) continue;
          seen.add(rk);
        }
      }
      let list = Array.from(seen);
      const preferred = PREFERRED_ORDER.filter(r => list.includes(r));
      const extra = list.filter(r => !PREFERRED_ORDER.includes(r)).sort();
      return [...preferred, ...extra];
    }
    function currentBossColumns() {
      // Council (11) represents an 11-member council pack; it's not directly comparable to single-boss kills.
      // Keep it hidden by default, but allow users to include it for reference.
      return BOSSES.filter(b => b.id !== "council11" || includeCouncil11);
    }

    function buildBossOrder(runesMatrix, baseBosses) {
      const base = [...baseBosses];
      if (!sortRune) return base;

      const r = sortRune;
      base.sort((a, b) => {
        const av = runesMatrix?.[a.id]?.[r] || 0;
        const bv = runesMatrix?.[b.id]?.[r] || 0;
        const d = bv - av;
        return sortDir === "desc" ? d : -d;
      });
      return base;
    }

    function fmtScientific(p) {
      if (!(p > 0)) return "-";
      return Number(p).toExponential(precision);
    }

    function fmtOneIn(p) {
      if (!(p > 0)) return "-";
      const n = 1 / Number(p);
      if (!Number.isFinite(n)) return "-";
      return `1:${Math.round(n).toLocaleString("en-US")}`;
    }

    function fmtPerScale(p, scale, label) {
      if (!(p > 0)) return "-";
      const v = Number(p) * scale;
      // Use fixed decimals for intuitive reading; trim trailing zeros for compactness.
      const s = v.toFixed(precision).replace(/\.0+$/,'').replace(/(\.\d*?)0+$/,'$1');
      return s;
    }

    function cellText(p) {
      if (fmtMode === "onein") return fmtOneIn(p);
      if (fmtMode === "per10k") return fmtPerScale(p, 10000);
      if (fmtMode === "per1m") return fmtPerScale(p, 1000000);
      return fmtScientific(p);
    }

    function cellTitle(p) {
      if (!(p > 0)) return "0";
      const oneIn = 1 / p;
      const oneInStr = Number.isFinite(oneIn) ? `1:${Math.round(oneIn).toLocaleString("en-US")}` : "-";
      const per10k = (p * 10000).toFixed(3);
      const per1m = (p * 1000000).toFixed(3);
      return `perKill=${p} | ${oneInStr} | per10k=${per10k} | per1m=${per1m}`;
    }

    function buildMetaPills() {
      const first = bossesDataAll?.[0]?.data;
      const meta = formatBossMeta(first);
      // Count only *visible* boss columns (since Council(11) may be toggled off).
      const bossCount = currentBossColumns().length;
      const modeLabel = (
        fmtMode === "onein" ? t("mode.onein") :
        fmtMode === "per10k" ? t("mode.per10k") :
        fmtMode === "per1m" ? t("mode.per1m") :
        t("mode.scientific")
      );
      const pills = [
        `<span class="pill">${t("pill.dataset")} <strong>${meta || "-"}</strong></span>`,
        `<span class="pill">${t("pill.bosses")} <strong>${bossCount}</strong></span>`,
        `<span class="pill">${t("pill.mode")} <strong>${modeLabel}</strong></span>`,
        `<span class="pill">${t("pill.precision")} <strong>${precision}</strong></span>`,
      ];
      if (sortRune) pills.push(`<span class="pill">${t("pill.sorted")} <strong>${sortRune} ${sortDir === "desc" ? t("pill.down") : t("pill.up")}</strong></span>`);
      el("metaPills").innerHTML = pills.join("");
    }

    function render() {
      setErr(null);

      const runes = buildRuneRows();

      // matrix[bossId][rune] = perKill
      const matrix = {};
      for (const b of (bossesDataAll || [])) {
        const d = b?.data?.drops || {};
        const m = {};
        for (const r of runes) m[r] = Number(d[r] || d[normRune(r)] || 0);
        matrix[b.id] = m;
      }

      const bossOrder = buildBossOrder(matrix, currentBossColumns());

      // head
      const thead = el("thead");
      thead.innerHTML = "";
      const hr = document.createElement("tr");
      hr.innerHTML = `<th class="corner">${t("tbl.rune")}</th>` + bossOrder.map(b => `<th class="mono">${b.label}</th>`).join("");
      thead.appendChild(hr);

      // body
      const tbody = el("tbody");
      tbody.innerHTML = "";

      for (const r of runes) {
        const tr = document.createElement("tr");

        const isSorted = sortRune === r;
        const arrow = isSorted ? (sortDir === "desc" ? "v" : "^") : "";

        const td0 = document.createElement("td");
        td0.className = "sticky runeBtn mono";
        td0.innerHTML = `${r} <span class="hint">${arrow}</span>`;
        td0.title = t("tip.clickToSort");
        td0.onclick = () => {
          if (sortRune === r) {
            sortDir = (sortDir === "desc") ? "asc" : "desc";
          } else {
            sortRune = r;
            sortDir = "desc";
          }
          buildMetaPills();
          render();
        };
        tr.appendChild(td0);

        for (const b of bossOrder) {
          const p = matrix?.[b.id]?.[r] || 0;
          const td = document.createElement("td");
          td.className = "num";
          td.textContent = cellText(p);
          td.title = cellTitle(p);
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }

      buildMetaPills();
    }

    async function loadBossesData() {
      // Load all boss datasets up-front so toggling columns (e.g., Council(11)) doesn't require re-fetching.
      const cols = BOSSES;
      const rows = await Promise.all(
        cols.map(async (b) => {
          const data = await loadBossDropsByFileId(b.id);
          return { ...b, data };
        })
      );
      return rows;
    }

    async function main() {
      try {
        priceTable = await loadPriceTable();
        bossesDataAll = await loadBossesData();

        await initI18n();

        // wire controls
        el("showAll").checked = showAll;
        el("showAll").onchange = (e) => { showAll = !!e.target.checked; sortRune = null; buildMetaPills(); render(); };

        // Optional boss column: Council (11)
        el("showCouncil11").checked = includeCouncil11;
        el("showCouncil11").onchange = (e) => {
          includeCouncil11 = !!e.target.checked;
          // If sorting, keep the same rune, but rebuilding will reorder columns against the new set.
          buildMetaPills();
          render();
        };

        el("fmtSel").value = fmtMode;
        el("fmtSel").onchange = (e) => { fmtMode = e.target.value; buildMetaPills(); render(); };

        el("precSel").value = String(precision);
        el("precSel").onchange = (e) => {
          const v = Number(e.target.value);
          precision = Number.isFinite(v) ? v : 3;
          buildMetaPills();
          render();
        };

        render();
      } catch (err) {
        setErr(String(err?.message || err));
      }
    }

    main();
  </script>
</body>
</html>
