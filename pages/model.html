<!doctype html>
<!-- /pages/model.html -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D2R Model (Theory EV)</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e7eefc; --muted:#9db0d1;
      --accent:#65d2ff; --good:#8bffb1; --warn:#ffd38b; --bad:#ff8b8b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; background:linear-gradient(180deg,#070c16,var(--bg)); color:var(--text); font-family:var(--sans); }
    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; }
    h1{ font-size:20px; margin:0 0 14px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .row{ grid-template-columns:1fr; } }
    .card{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06); border-radius:14px; padding:16px; box-shadow:0 12px 26px rgba(0,0,0,0.35); }
    .card h2{ margin:0 0 10px; font-size:15px; color:var(--muted); }
    .sub{ color:var(--muted); font-size:12px; line-height:1.4; margin-top:6px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:12px 0 6px; }
    input, select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.22); color:var(--text); outline:none; }
    button{ width:100%; margin-top:12px; padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800; background:var(--accent); color:#05101f; }
    .mono{ font-family:var(--mono); }
    .kv{ display:flex; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.06); }
    .kv:last-child{ border-bottom:0; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ font-family:var(--mono); font-size:12px; white-space:nowrap; }
    .big{ font-size:38px; font-weight:900; letter-spacing:-0.02em; }
    .unit{ font-size:12px; color:var(--muted); margin-left:8px; font-weight:700; }
    .pillbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.18); font-size:12px; color:var(--muted); }
    .pill strong{ color:var(--text); font-family:var(--mono); }
    .divider{ height:1px; background:rgba(255,255,255,0.06); margin:14px 0; }
    .note{ font-size:12px; color:var(--warn); margin-top:10px; }
    .err{ font-size:12px; color:var(--bad); white-space:pre-wrap; }
    .ok{ color:var(--good); }
  
    .cap{ font-weight:900; color:var(--text); }
    .heroRow .k{ font-weight:900; color:var(--text); }
    .heroSmallNum{ font-size:26px; font-weight:900; letter-spacing:-0.01em; }
    .heroBigNum{ font-size:40px; font-weight:900; letter-spacing:-0.02em; }
    .heroUnit{ font-size:12px; color:var(--muted); margin-left:8px; font-weight:800; }
    .breakline{ margin-top:6px; font-size:13px; color:var(--text); font-weight:800; }
    .breakline .mut{ color:var(--muted); font-weight:800; }
    .itemsLine{ font-size:12px; color:var(--muted); font-family:var(--mono); line-height:1.5; }

</style>
</head>
<body>
  <div class="wrap">
    <h1>D2R Keys Model (Theory EV) — key-by-key rotation, extras only from Countess</h1>

    <div class="card" style="margin-bottom:16px">
      <div class="row" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Price phase</label>
          <select id="phaseSel"></select>
          <div class="sub">/config/rune-price-table.json</div>
        </div>
        <div>
          <label>Model parameters</label>
          <div class="sub">/config/model-parameters.json</div>
          <div class="pillbar" id="quickStats"></div>
        </div>
      </div>
      <div class="sub">
        Key value: 1 key = 1/3 Ist. Bonus is shown separately (EV only).
      </div>
      <div class="err" id="loadErr" style="display:none"></div>
    </div>

    <div class="row">
      <div class="card">
        <h2>1) Target Ist → required hours + EV drops</h2>
        <label>Target Ist (exclude bonus)</label>
        <input id="targetIst" type="number" min="0" step="0.1" value="45" />
        <button id="btnTarget">Calculate</button>
        <div class="divider"></div>
        <div id="outTarget"></div>
      </div>

      <div class="card">
        <h2>2) Target hours → predicted Ist/h</h2>
        <label>Hours</label>
        <input id="hours" type="number" min="0" step="0.1" value="10" />
        <button id="btnHours">Calculate</button>
        <div class="divider"></div>
        <div id="outHours"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { loadModelConfigs, getPhaseOptions, computeTheoryFromHours, computeTheoryFromTargetIst, priceInIst } from "../model/modelCore.js";

    const el = (id) => document.getElementById(id);
    const fmt = (x, d=2) => (x == null || Number.isNaN(Number(x))) ? "-" : Number(x).toFixed(d);

    let cfg = null;
    let phaseKey = null;

    function currentPhaseData() {
      const phases = cfg?.priceTable?.phases ?? {};
      return phases?.[phaseKey] ?? {};
    }

    function getDefaults() {
      const d = cfg?.modelParameters?.defaults ?? {};
      return {
        Dc: Number(d.Dc),
        Ds: Number(d.Ds),
        Dn: Number(d.Dn),
        tC_min: Number(d.tC_min),
        tS_min: Number(d.tS_min),
        tN_min: Number(d.tN_min),
        extras: d.extras ?? []
      };
    }

    function buildQuickStats() {
      const { Dc, Ds, Dn, tC_min, tS_min, tN_min, extras } = getDefaults();
      const pd = currentPhaseData();

      const timePerKeyC = (tC_min / Dc);
      const timePerKeyS = (tS_min / Ds);
      const timePerKeyN = (tN_min / Dn);
      const cycleMin = timePerKeyC + timePerKeyS + timePerKeyN;

      const extraNames = [...new Set((extras ?? []).map(x => String(x?.name ?? "").replace(/^BONUS\s*/i,"").trim()).filter(Boolean))];
      const picks = ["RAL","HEL","TAL","PG","PA","FG","FA","IST","UM","MAL"].filter(x => (x in pd) || extraNames.includes(x));
      const priceStr = picks.map(n => `${n}=${fmt(priceInIst(n, pd),4)}`).join(" · ");

      el("quickStats").innerHTML = [
        `<span class="pill">Dc <strong>${fmt(Dc,4)}</strong></span>`,
        `<span class="pill">Ds <strong>${fmt(Ds,4)}</strong></span>`,
        `<span class="pill">Dn <strong>${fmt(Dn,4)}</strong></span>`,
        `<span class="pill">tC <strong>${fmt(tC_min,2)}</strong> min</span>`,
        `<span class="pill">tS <strong>${fmt(tS_min,2)}</strong> min</span>`,
        `<span class="pill">tN <strong>${fmt(tN_min,2)}</strong> min</span>`,
        `<span class="pill">cycle (1 key each) <strong>${fmt(cycleMin,2)}</strong> min</span>`,
        `<span class="pill"><span class="mono">${priceStr || "prices loaded"}</span></span>`,
      ].join("");
    }

            function renderFromHours(r, hours) {
      const out = el("outHours");
      const s = r.schedule;
      const k = s.keys;

      const { extras, tC_min, tS_min, tN_min } = getDefaults();
      const Rc = s.runs.Rc;
      const Rs = s.runs.Rs;
      const Rn = s.runs.Rn;

      const cMin = Rc * tC_min;
      const sMin = Rs * tS_min;
      const nMin = Rn * tN_min;

      const regularDrops = [];
      const bonusDrops = [];

      for (const x of (extras ?? [])) {
        const rawName = String(x?.name ?? "").trim();
        const dpr = Number(x?.dropPerRun ?? 0);
        if (!rawName || !(dpr > 0)) continue;

        const isBonus = /^BONUS\b/i.test(rawName);
        const name = isBonus ? rawName.replace(/^BONUS\s*/i, "").trim() : rawName;
        const qty = Rc * dpr;

        const item = { name, qty };
        if (isBonus) bonusDrops.push(item);
        else regularDrops.push(item);
      }

      const inlineList = (items) => {
        if (!items.length) return "(none)";
        return items.map(it => `${it.name}: ${fmt(it.qty,2)}`).join(" · ");
      };

      out.innerHTML = `
        <div class="kv heroRow">
          <div class="k cap">Farming Time</div>
          <div class="v"><span class="heroSmallNum">${fmt(hours,2)}</span><span class="heroUnit">hour</span></div>
        </div>

        <div class="kv heroRow">
          <div class="k cap">Predicted Revenue</div>
          <div class="v"><span class="heroBigNum">${fmt(r.rates.istPerHourExclBonus,2)}</span><span class="heroUnit">Ist/hour</span></div>
        </div>

        <div class="kv heroRow">
          <div class="k cap">Total revenue</div>
          <div class="v"><span class="heroSmallNum">${fmt(r.values.totalIstExclBonus,2)}</span><span class="heroUnit">Ist</span></div>
        </div>

        <div class="breakline">
          Key: ${fmt(r.values.keyIst,2)} Ist, Extras: ${fmt(r.values.extrasRegularIst,2)} Ist
          <span class="mut">&nbsp;&nbsp;·&nbsp;&nbsp;Bonus (Not guaranteed): ${fmt(r.values.bonusIst,2)} Ist</span>
        </div>

        <div class="divider"></div>

        <div class="sub cap">Farming time (by boss)</div>
        <div class="itemsLine">Countess: ${fmt(cMin,2)} min · Summoner: ${fmt(sMin,2)} min · Nihl: ${fmt(nMin,2)} min</div>

        <div class="divider"></div>

        <div class="sub cap">Drops</div>
        <div class="itemsLine">${fmt(k.terror,2)} TKey · ${fmt(k.hate,2)} HKey · ${fmt(k.destruction,2)} DKey</div>

        <div class="divider"></div>

        <div class="sub cap">Predicted Extra Drops</div>
        <div class="itemsLine">${inlineList(regularDrops)}</div>

        <div class="divider"></div>

        <div class="sub cap">Bonus Drops (EV)</div>
        <div class="itemsLine">${inlineList(bonusDrops)}</div>
      `;
    }

    
    function renderTarget(result, targetIst) {
      const out = el("outTarget");
      const r = result.result;
      const hours = result.required.hours;

      const s = r.schedule;
      const k = s.keys;

      const { extras, tC_min, tS_min, tN_min } = getDefaults();
      const Rc = s.runs.Rc;
      const Rs = s.runs.Rs;
      const Rn = s.runs.Rn;

      const cMin = Rc * tC_min;
      const sMin = Rs * tS_min;
      const nMin = Rn * tN_min;

      const regularDrops = [];
      const bonusDrops = [];
      for (const x of (extras ?? [])) {
        const rawName = String(x?.name ?? "").trim();
        const dpr = Number(x?.dropPerRun ?? 0);
        if (!rawName || !(dpr > 0)) continue;

        const isBonus = /^BONUS\b/i.test(rawName);
        const name = isBonus ? rawName.replace(/^BONUS\s*/i, "").trim() : rawName;
        const qty = Rc * dpr;
        const item = { name, qty };
        if (isBonus) bonusDrops.push(item);
        else regularDrops.push(item);
      }

      const inlineList = (items) => {
        if (!items.length) return "(none)";
        return items.map(it => `${it.name}: ${fmt(it.qty,2)}`).join(" · ");
      };

      out.innerHTML = `
        <div class="kv heroRow">
          <div class="k cap">Target Ist</div>
          <div class="v"><span class="heroSmallNum">${fmt(targetIst,2)}</span><span class="heroUnit">Ist</span></div>
        </div>

        <div class="kv heroRow">
          <div class="k cap">Required hours</div>
          <div class="v"><span class="heroSmallNum">${fmt(hours,2)}</span><span class="heroUnit">hour</span></div>
        </div>

        <div class="kv heroRow">
          <div class="k cap">Predicted Revenue</div>
          <div class="v"><span class="heroBigNum">${fmt(r.rates.istPerHourExclBonus,2)}</span><span class="heroUnit">Ist/hour</span></div>
        </div>

        <div class="kv heroRow">
          <div class="k cap">Total revenue</div>
          <div class="v"><span class="heroSmallNum">${fmt(r.values.totalIstExclBonus,2)}</span><span class="heroUnit">Ist</span></div>
        </div>

        <div class="breakline">
          Key: ${fmt(r.values.keyIst,2)} Ist, Extras: ${fmt(r.values.extrasRegularIst,2)} Ist
          <span class="mut">&nbsp;&nbsp;·&nbsp;&nbsp;Bonus (Not guaranteed): ${fmt(r.values.bonusIst,2)} Ist</span>
        </div>

        <div class="divider"></div>

        <div class="sub cap">Farming time (by boss)</div>
        <div class="itemsLine">Countess: ${fmt(cMin,2)} min · Summoner: ${fmt(sMin,2)} min · Nihl: ${fmt(nMin,2)} min</div>

        <div class="divider"></div>

        <div class="sub cap">Drops</div>
        <div class="itemsLine">${fmt(k.terror,2)} TKey · ${fmt(k.hate,2)} HKey · ${fmt(k.destruction,2)} DKey</div>

        <div class="divider"></div>

        <div class="sub cap">Predicted Extra Drops</div>
        <div class="itemsLine">${inlineList(regularDrops)}</div>

        <div class="divider"></div>

        <div class="sub cap">Bonus Drops (EV)</div>
        <div class="itemsLine">${inlineList(bonusDrops)}</div>

        <div class="note">Target solving uses bisection over the same EV rotation model.</div>
      `;
    }


    async function main() {
      try {
        cfg = await loadModelConfigs();
        const { phases, defaultPhase } = getPhaseOptions(cfg.priceTable);
        phaseKey = defaultPhase;

        const sel = el("phaseSel");
        sel.innerHTML = Object.keys(phases)
          .sort((a,b)=>Number(a)-Number(b))
          .map(k => `<option value="${k}">Phase ${k}</option>`)
          .join("");
        sel.value = phaseKey;
        sel.addEventListener("change", () => { phaseKey = sel.value; buildQuickStats(); });

        buildQuickStats();

        el("btnHours").addEventListener("click", () => {
          const hours = Number(el("hours").value);
          const { Dc, Ds, Dn, tC_min, tS_min, tN_min, extras } = getDefaults();
          const r = computeTheoryFromHours({
            hours,
            Dc, Ds, Dn,
            tC_min, tS_min, tN_min,
            extras,
            phaseData: currentPhaseData()
          });
          renderFromHours(r, hours);
        });

        el("btnTarget").addEventListener("click", () => {
          const targetIst = Number(el("targetIst").value);
          const { Dc, Ds, Dn, tC_min, tS_min, tN_min, extras } = getDefaults();
          const res = computeTheoryFromTargetIst({
            targetIst,
            Dc, Ds, Dn,
            tC_min, tS_min, tN_min,
            extras,
            phaseData: currentPhaseData()
          });
          renderTarget(res, targetIst);
        });

        el("btnHours").click();
        el("btnTarget").click();

      } catch (e) {
        const errEl = el("loadErr");
        errEl.style.display = "block";
        errEl.textContent = `CONFIG LOAD ERROR\n\n${e?.message ?? e}`;
      }
    }

    main();
  </script>
</body>
</html>
