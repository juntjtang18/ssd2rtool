<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSD2R Tool ‚Äî Runewords Planner</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --text:#e7eef7; --muted:#9db0c6; --line:#223041; --accent:#7bdcff; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 22px 16px 40px; }

    .topbar { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    h1 { margin: 6px 0 8px; font-size: 22px; }
    .sub { color:var(--muted); margin: 0 0 16px; line-height: 1.55; }

    .langbox { display:flex; align-items:center; gap:8px; margin-top: 6px; }
    .langbox .globe { font-size: 16px; opacity:.9; }
    .langbox select { width: 140px; padding: 10px 10px; border-radius: 10px; border: 1px solid var(--line); background:#0f1318; color:var(--text); font-size: 14px; }

    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 980px){ .grid { grid-template-columns: 1fr 1fr; } }

    .card { background:var(--card); border:1px solid var(--line); border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 14px; color: var(--accent); font-weight: 900; letter-spacing: .2px; }

    .row { display:flex; gap:10px; align-items:center; margin: 10px 0; }
    label { flex: 1; color:var(--muted); font-size: 13px; }
    select, input { width: 280px; padding: 10px 10px; border-radius: 10px; border: 1px solid var(--line); background:#0f1318; color:var(--text); font-size: 14px; }
    .btn { width: 100%; padding: 12px 14px; border: 0; border-radius: 12px; background: var(--accent); color:#05202a; font-weight: 900; cursor:pointer; margin-top: 8px; }

    .tiny { color:var(--muted); font-size: 12px; line-height: 1.55; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .bigNumber { font-size: 44px; font-weight: 950; margin: 6px 0 2px; line-height: 1.0; }
    .bigUnit { font-size: 13px; color: var(--muted); font-weight: 900; margin-left: 6px; }

    .box { border: 1px solid var(--line); border-radius: 12px; padding: 12px; background:#0f1318; }
    .divider { height:1px; background: var(--line); margin: 10px 0; }

    .planGrid { display:grid; grid-template-columns: 1fr 110px 110px; gap: 8px 10px; align-items:center; }
    .planHdr { color: var(--muted); font-weight: 900; font-size: 12px; }
    .planBoss { color: var(--accent); font-weight: 950; font-size: 14px; }
    .right { text-align:right; }
    .stopLine { margin-top: 10px; font-size: 14px; font-weight: 950; }

    .tradeGrid { display:grid; grid-template-columns: 1fr 160px; gap: 6px 12px; margin-top: 6px; }
    .tradeKey { color: var(--accent); font-weight: 950; }

    table { width:100%; border-collapse: collapse; }
    td { padding: 8px 0; border-bottom: 1px solid #1c2735; }
    .k { color: var(--accent); font-weight: 900; }
    .muted { color: var(--muted); }


    details { margin-top: 10px; }
    summary { cursor: pointer; color: var(--muted); font-weight: 900; font-size: 13px; }
    summary::-webkit-details-marker { display: none; }
    summary:before { content: '‚ñ∏ '; color: var(--muted); }
    details[open] summary:before { content: '‚ñæ '; }

    .btnGhost { width: auto; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--line); background:#0f1318; color:var(--text); font-weight: 800; cursor:pointer; }
    .btnGhost:hover { border-color: #2f4a63; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 data-i18n="title">SSD2R Tool ‚Äî Runewords Planner</h1>
        <div class="sub" data-i18n="subtitle">Pick a runeword + season phase ‚Üí get a farming plan.</div>
      </div>

      <div class="langbox" title="Language">
        <span class="globe">üåê</span>
        <select id="langSel" aria-label="Language">
          <option value="zh-Hant">ÁπÅÈ´î</option>
          <option value="zh-Hans">ÁÆÄ‰Ωì</option>
          <option value="en">EN</option>
        </select>
      </div>
    </div>

    <!-- Top row -->
    <div class="grid">
      <!-- Inputs -->
      <div class="card">
        <h2 data-i18n="inputs.title">Inputs</h2>

        <div class="row">
          <label data-i18n="inputs.phase">Season phase</label>
          <select id="phase">
            <option value="1" data-i18n="phase.1">Phase 1</option>
            <option value="2" data-i18n="phase.2">Phase 2</option>
            <option value="3" data-i18n="phase.3">Phase 3</option>
          </select>
        </div>

        <div class="row">
          <label data-i18n="inputs.search">Search</label>
          <input id="q" placeholder="e.g. infi / hoto / enigma" />
        </div>

        <div class="row">
          <label data-i18n="inputs.runeword">Runeword</label>
          <select id="rw"></select>
        </div>

        <button class="btn" id="calc" data-i18n="btn.calc">Calculate</button>

        <details id="runtimeDetails">
          <summary data-i18n="inputs.runtimeSummary">Customize run times (minutes)</summary>

          <div class="row" style="margin-top:10px;">
            <label data-i18n="inputs.runtime.countess">Countess run (min)</label>
            <input id="tC" type="number" step="0.1" min="0" />
          </div>

          <div class="row">
            <label data-i18n="inputs.runtime.summoner">Summoner run (min)</label>
            <input id="tS" type="number" step="0.1" min="0" />
          </div>

          <div class="row">
            <label data-i18n="inputs.runtime.nihil">Nihlathak run (min)</label>
            <input id="tN" type="number" step="0.1" min="0" />
          </div>

          <div class="row" style="justify-content:space-between;">
            <div class="tiny muted" data-i18n="inputs.runtimeNote">Saved locally in your browser.</div>
            <button type="button" class="btnGhost" id="resetTimes" data-i18n="inputs.runtimeReset">Reset</button>
          </div>
        </details>


        <details id="priceDetails">
          <summary data-i18n="inputs.priceSummary">Customize price table</summary>

          <div class="tiny muted" style="margin-top:10px;" data-i18n="inputs.priceNote">Edit offer/need values. Saved locally in your browser.</div>

          <div class="box" style="margin-top:10px; max-height:260px; overflow:auto;">
            <table class="mono" id="priceTableEditor"></table>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:10px;">
            <div class="tiny muted"></div>
            <button type="button" class="btnGhost" id="resetPrices" data-i18n="inputs.priceReset">Reset</button>
          </div>
        </details>


        <div class="tiny" style="margin-top:10px;">
          <a href="../index.html" data-i18n="nav.back">‚Üê Back</a> &nbsp;|&nbsp;
          <a href="./model.html" data-i18n="nav.keyPipeline">Key Pipeline</a>
        </div>
      </div>

      <!-- Planner -->
      <div class="card">
        <h2 data-i18n="planner.title">Planner</h2>

        <div class="tiny" data-i18n="planner.totalTime">Total time</div>
        <div class="bigNumber"><span id="totalHours">‚Äî</span><span class="bigUnit">Hours</span></div>

        <div class="box" style="margin-top:10px;">
          <div class="planGrid mono" id="planGrid"></div>
          <div class="stopLine mono" id="targetLine">‚Äî</div>
        </div>

        <div class="box" style="margin-top:12px;">
          <div class="tiny muted" style="font-weight:900;" data-i18n="planner.tradeList">Trade list (extras)</div>
          <div class="tradeGrid mono" id="tradeList">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Bottom row -->
    <div class="grid" style="margin-top:14px;">
      <!-- Rune cost on LEFT -->
      <div class="card">
        <h2 data-i18n="cost.title">Rune cost</h2>
        <div class="bigNumber" style="font-size:34px;">
          <span id="totalCost">‚Äî</span><span class="bigUnit">Ist</span>
        </div>
        <div class="divider"></div>
        <table class="mono" id="breakdownTable"></table>
      </div>

      <!-- Predicted drops on RIGHT -->
      <div class="card">
        <h2 data-i18n="drops.title">Predicted drops</h2>
        <div class="box">
          <table class="mono" id="dropsTable"></table>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { loadPriceTable } from "../model/priceTable.js";
    import { breakdownRuneword } from "../model/runewordsPlanner.js";
    import { planRotationToTargetIst } from "../model/keysPipeline.js";

    import { detectLang, loadI18nJson, makeT, applyI18nToDom } from "../model/i18n.js";

    const el = (id) => document.getElementById(id);

    // display-only buffer: ONLY applied to big total hours
    const DISPLAY_BUFFER = 1.00;

    // formatting rules for UX
    const fmtHours = (x) => (Number.isFinite(x) ? x.toFixed(1) : "‚Äî");     // 1 decimal
    const fmtIst1  = (x) => (Number.isFinite(x) ? x.toFixed(1) : "‚Äî");     // 1 decimal
    //const asInt    = (x) => String(Math.max(0, Math.round(Number(x || 0)))); // integer count
    function asInt(x) {
      const n = Number(x ?? 0);
      return String(Math.ceil(n));
    }

    const els = {
      langSel: el("langSel"),

      phase: el("phase"),
      q: el("q"),
      rw: el("rw"),
      calc: el("calc"),

      totalHours: el("totalHours"),
      planGrid: el("planGrid"),
      targetLine: el("targetLine"),
      tradeList: el("tradeList"),

      dropsTable: el("dropsTable"),
      totalCost: el("totalCost"),
      breakdownTable: el("breakdownTable"),

      runtimeDetails: el("runtimeDetails"),
      tC: el("tC"),
      tS: el("tS"),
      tN: el("tN"),
      resetTimes: el("resetTimes"),
   
      priceDetails: el("priceDetails"),
      priceTableEditor: el("priceTableEditor"),
      resetPrices: el("resetPrices"),
    };

    let priceTable = null;
    let runewordsData = null;
    let modelDefaults = null;
    let tcDropTable = null;
    let keyRuns = null;

    // i18n
    let dict = null;
    let currentLang = "en";
    let t = (key, vars=null) => key; // placeholder until loaded

    async function loadRunewords() {
      const res = await fetch("../config/runewords.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load runewords.json: HTTP ${res.status}`);
      return await res.json();
    }

    async function loadModelDefaults() {
      const res = await fetch("../config/model-parameters.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load model-parameters.json: HTTP ${res.status}`);
      const json = await res.json();
      return json.defaults;
    }

    async function loadTcDropTable() {
      const res = await fetch("../config/tc/tc-drop-table.hell.p1.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load tc-drop-table: HTTP ${res.status}`);
      return await res.json();
    }

    async function loadKeyRuns() {
      const [c, s, n] = await Promise.all([
        fetch("../config/map_runs/tower-cellar-5.hell.p1.run.json", { cache: "no-store" }),
        fetch("../config/map_runs/arcane-sanctuary.hell.p1.run.json", { cache: "no-store" }),
        fetch("../config/map_runs/nilh-halls.hell.p1.run.json", { cache: "no-store" }),
      ]);
      if (!c.ok) throw new Error(`Failed to load countess map_run: HTTP ${c.status}`);
      if (!s.ok) throw new Error(`Failed to load summoner map_run: HTTP ${s.status}`);
      if (!n.ok) throw new Error(`Failed to load nihl map_run: HTTP ${n.status}`);
      return {
        countess: await c.json(),
        summoner: await s.json(),
        nihl: await n.json(),
      };
    }

    async function initI18n() {
      dict = await loadI18nJson("../i18n/runewords-planner.json");
      const lang = detectLang();
      applyLang(lang, { rerender: false });
    }

    function applyLang(lang, { rerender = true } = {}) {
      currentLang = lang;
      localStorage.setItem("lang", lang);
      t = makeT(dict, lang);

      document.documentElement.lang = lang;
      document.title = t("title");
      applyI18nToDom(t);

      // keep selector in sync
      els.langSel.value = lang;

      // refresh all dynamic UI using the selected language
      if (rerender) {
        renderPriceEditor();
        calc();
      }
    }

    function setPhaseDefault() {
      const saved = localStorage.getItem("seasonPhase");
      const def = saved || String(priceTable.defaultPhase || modelDefaults.seasonPhase || 2);
      els.phase.value = ["1","2","3"].includes(def) ? def : "2";
    }

    function renderRunewordOptions() {
      const query = (els.q.value || "").trim().toLowerCase();
      const list = (runewordsData.runewords || []).filter(r => {
        if (!query) return true;
        const hay = `${r.name} ${r.id}`.toLowerCase();
        return hay.includes(query);
      });

      const prev = els.rw.value;
      els.rw.innerHTML = "";

      for (const r of list) {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.name; // runeword name stays game-native
        els.rw.appendChild(opt);
      }

      if (Array.from(els.rw.options).some(o => o.value === prev)) els.rw.value = prev;

      if (!els.rw.options.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "(no match)";
        els.rw.appendChild(opt);
      }
    }

    function getSelectedRuneword() {
      const id = els.rw.value;
      return (runewordsData.runewords || []).find(x => x.id === id);
    }

    function renderRuneCost(rw, phase, effPriceTable) {
      const b = breakdownRuneword({ priceTable: effPriceTable, phase, runes: rw.runes });

      els.totalCost.textContent = fmtIst1(b.totalIst);

      els.breakdownTable.innerHTML = "";
      for (const row of b.rows) {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = row.rune;

        const td2 = document.createElement("td");
        td2.style.textAlign = "right";
        td2.textContent = fmtIst1(row.priceIst);

        tr.appendChild(td1);
        tr.appendChild(td2);
        els.breakdownTable.appendChild(tr);
      }

      const tr = document.createElement("tr");
      const td1 = document.createElement("td");
      td1.textContent = t("total");
      const td2 = document.createElement("td");
      td2.style.textAlign = "right";
      td2.textContent = fmtIst1(b.totalIst);
      tr.appendChild(td1);
      tr.appendChild(td2);
      els.breakdownTable.appendChild(tr);

      return b;
    }

    function renderPlan(plan) {
      // buffer only the big number
      els.totalHours.textContent = fmtHours(plan.hours.total * DISPLAY_BUFFER);

      els.planGrid.innerHTML = "";
      const add = (txt, cls="") => {
        const d = document.createElement("div");
        d.className = cls;
        d.textContent = txt;
        els.planGrid.appendChild(d);
      };

      add("", "planHdr");
      add(t("col.hours"), "planHdr right");
      add(t("col.runs"), "planHdr right");

      add(t("boss.countess"), "planBoss");
      add(fmtHours(plan.hours.countess), "right");
      add(asInt(plan.runs.countess), "right");


      add(t("boss.summoner"), "planBoss");
      add(fmtHours(plan.hours.summoner), "right");
      add(asInt(plan.runs.summoner), "right");


      add(t("boss.nihil"), "planBoss");
      add(fmtHours(plan.hours.nihl), "right");
      add(asInt(plan.runs.nihl), "right");

      els.targetLine.textContent = t("planner.stopAt", { N: plan.keys.keysets });
    }

    function renderTradeList(plan) {
      const rows = Array.isArray(plan.tradeList) ? plan.tradeList : [];
      els.tradeList.innerHTML = "";

      if (!rows.length) {
        els.tradeList.textContent = "‚Äî";
        return;
      }

      for (const r of rows) {
        const left = document.createElement("div");
        left.innerHTML = `<span class="tradeKey">${r.name}</span>  (${r.O}√ó${r.orders})`;

        const right = document.createElement("div");
        right.style.textAlign = "right";
        right.textContent = `${Math.round(Number(r.ist || 0))} Ist`;

        els.tradeList.appendChild(left);
        els.tradeList.appendChild(right);
      }
    }

    // Predicted drops table:
    // - Always shows keysets
    // - Shows predictable items (integer-only)
    // - Shows lottery probabilities for Vex+/Lo+/Jah+
    function renderPredictedDrops(plan) {
      const pd = plan?.predictedDrops ?? {};
      const predictable = Array.isArray(pd.predictable)
        ? pd.predictable
        : (Array.isArray(pd.extras) ? pd.extras : []);

      const bonusLegacy = Array.isArray(pd.bonus) ? pd.bonus : [];
      const probs = pd.lotteryProbs ?? null;

      const MIN_PCS = 1;

      const fmtPct = (p) => {
        const x = Number(p ?? 0);
        if (!(x > 0)) return "0%";
        if (x < 0.0001) return "<0.01%";
        if (x < 0.01) return `${(x * 100).toFixed(2)}%`;
        return `${(x * 100).toFixed(1)}%`;
      };

      const predictableShown = predictable
        .map(x => ({ name: x.name, pcs: Number(x.pcs || 0) }))
        .filter(x => x.pcs >= MIN_PCS)
        .sort((a,b) => b.pcs - a.pcs);

      const bonusShown = bonusLegacy
        .filter(x => Number(x.pcs || 0) >= MIN_PCS)
        .sort((a,b) => Number(b.pcs||0) - Number(a.pcs||0));

      els.dropsTable.innerHTML = "";

      const tr = (k, v, cls="") => {
        const row = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.className = cls;
        td1.textContent = k;
        const td2 = document.createElement("td");
        td2.style.textAlign = "right";
        td2.textContent = v;
        row.appendChild(td1);
        row.appendChild(td2);
        return row;
      };

      // Keysets
      els.dropsTable.appendChild(tr(t("drops.keysets"), String(plan.keys.keysets), "k"));

      // Predictable drops
      for (const x of predictableShown) {
        if (!x.name || x.name === "UKEY") continue;
        els.dropsTable.appendChild(tr(x.name, asInt(x.pcs)));
      }

      // Lottery probabilities (preferred)
      if (probs) {
        els.dropsTable.appendChild(tr("", ""));
        els.dropsTable.appendChild(tr(t("drops.lotteryTitle"), "", "muted"));
        els.dropsTable.appendChild(tr(t("drops.vexPlus"), fmtPct(probs.vexPlus)));
        els.dropsTable.appendChild(tr(t("drops.loPlus"), fmtPct(probs.loPlus)));
        els.dropsTable.appendChild(tr(t("drops.jahPlus"), fmtPct(probs.jahPlus)));
        return;
      }

      // Legacy bonus (kept for backwards compatibility)
      if (bonusShown.length) {
        els.dropsTable.appendChild(tr("", ""));
        els.dropsTable.appendChild(tr(t("drops.bonusTitle"), "", "muted"));
        for (const b of bonusShown) {
          els.dropsTable.appendChild(tr(b.name, asInt(b.pcs)));
        }
      }
    }

    function renderZeroState() {
      els.totalHours.textContent = fmtHours(0);

      els.planGrid.innerHTML = "";
      const add = (txt, cls="") => {
        const d = document.createElement("div");
        d.className = cls;
        d.textContent = txt;
        els.planGrid.appendChild(d);
      };

      add("", "planHdr");
      add(t("col.hours"), "planHdr right");
      add(t("col.runs"), "planHdr right");

      add(t("boss.countess"), "planBoss");
      add(fmtHours(0), "right");
      add("0", "right");

      add(t("boss.summoner"), "planBoss");
      add(fmtHours(0), "right");
      add("0", "right");

      add(t("boss.nihil"), "planBoss");
      add(fmtHours(0), "right");
      add("0", "right");

      els.targetLine.textContent = t("planner.stopAt", { N: 0 });

      els.tradeList.textContent = "‚Äî";

      els.dropsTable.innerHTML = "";
      els.dropsTable.appendChild((() => {
        const row = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.className = "k";
        td1.textContent = t("drops.keysets");
        const td2 = document.createElement("td");
        td2.style.textAlign = "right";
        td2.textContent = "0";
        row.appendChild(td1);
        row.appendChild(td2);
        return row;
      })());
    }

    function renderLowCostState() {
      // For < 1 Ist runewords, the key pipeline planner becomes misleading.
      // Countess can drop all low runes (below IST) at high frequency.
      els.totalHours.textContent = "‚Äî";

      // Replace the plan grid with a single hint message.
      els.planGrid.innerHTML = "";
      const hint = document.createElement("div");
      hint.style.gridColumn = "1 / -1";
      hint.style.color = "var(--muted)";
      hint.style.fontWeight = "900";
      hint.textContent = t("planner.lowCostHint");
      els.planGrid.appendChild(hint);

      // Keep the stop line clean (avoid duplicate hint lines).
      els.targetLine.textContent = "‚Äî";

      els.tradeList.textContent = "‚Äî";

      // Predicted drops are not meaningful here; show zero-state table.
      els.dropsTable.innerHTML = "";
      els.dropsTable.appendChild((() => {
        const row = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.className = "k";
        td1.textContent = t("drops.keysets");
        const td2 = document.createElement("td");
        td2.style.textAlign = "right";
        td2.textContent = "0";
        row.appendChild(td1);
        row.appendChild(td2);
        return row;
      })());
    }



    // --- Runtime customization (per-boss minutes/run) ---
    // Stored in localStorage so users can tune the planner to their own routing/speed.
    const RT_KEYS = {
      tC_min: "rt_tC_min",
      tS_min: "rt_tS_min",
      tN_min: "rt_tN_min",
    };

    // Price table overrides (per phase), stored locally.
    const PT_KEYS_PREFIX = "pt_override_";

    function getPhasePriceTable(basePriceTable, phase) {
      const p = String(phase);
      return basePriceTable?.phases?.[p] || {};
    }

    function loadPriceOverrides(phase) {
      try {
        const raw = localStorage.getItem(PT_KEYS_PREFIX + String(phase));
        if (!raw) return {};
        const obj = JSON.parse(raw);
        return obj && typeof obj === "object" ? obj : {};
      } catch {
        return {};
      }
    }

    
    function gcdInt(a, b) {
      a = Math.abs(Math.round(a));
      b = Math.abs(Math.round(b));
      while (b) {
        const t = a % b;
        a = b;
        b = t;
      }
      return a || 1;
    }

    // Normalize a quote into integer Offer/Need (O/N), by scaling to clear decimals.
    // Example: N=0.5 -> O*=2, N=1; N=0.1 -> O*=10, N=1
    function normalizeQuote(q) {
      if (q == null) return { O: 1, N: 1 };

      let O, N;
      if (typeof q === "number") {
        O = 1;
        N = Number(q);
      } else {
        O = Number(q.O ?? 1);
        N = Number(q.N ?? 1);
      }

      if (!Number.isFinite(O) || O <= 0) O = 1;
      if (!Number.isFinite(N) || N <= 0) N = 1;

      // find smallest scale (<= 1000) that makes N*scale an integer
      const eps = 1e-9;
      let scale = 1;
      for (let s = 1; s <= 1000; s++) {
        const v = N * s;
        if (Math.abs(v - Math.round(v)) < eps) { scale = s; break; }
      }

      O = Math.round(O * scale);
      N = Math.round(N * scale);

      // reduce ratio
      const g = gcdInt(O, N);
      O = Math.max(1, Math.round(O / g));
      N = Math.max(1, Math.round(N / g));
      return { O, N };
    }
function savePriceOverrides(phase, overrides) {
      localStorage.setItem(PT_KEYS_PREFIX + String(phase), JSON.stringify(overrides || {}));
    }

    function resetPriceOverrides(phase) {
      localStorage.removeItem(PT_KEYS_PREFIX + String(phase));
    }

    function buildEffectivePriceTable(basePriceTable, phase) {
      const p = String(phase);
      const base = getPhasePriceTable(basePriceTable, p);
      const ov = loadPriceOverrides(p);

      // Only allow overrides for existing items (no adding new ones).
      const mergedPhase = {};
      for (const k of Object.keys(base)) {
        const b = base[k];
        const o = ov[k];
        if (o && typeof o === "object") {
          const O = Number(o.O);
          const N = Number(o.N);
          mergedPhase[k] = {
            O: Number.isFinite(O) && O > 0 ? O : Number(b.O),
            N: Number.isFinite(N) && N > 0 ? N : Number(b.N),
          };
        } else {
          mergedPhase[k] = b;
        }
      }

      return {
        ...basePriceTable,
        phases: {
          ...(basePriceTable?.phases || {}),
          [p]: mergedPhase,
        },
      };
    }

    function renderPriceEditor() {
      const phase = els.phase.value;
      const base = getPhasePriceTable(priceTable, phase);
      const ov = loadPriceOverrides(phase);

      // Build table header
      const tbl = els.priceTableEditor;
      tbl.innerHTML = "";

      const thead = document.createElement("tr");
      thead.innerHTML = `
        <th style="text-align:left; padding-right:12px;">Item</th>
        <th style="text-align:right; padding-right:12px;">${t("inputs.priceOffer", "Offer")}</th>
        <th style="text-align:right;">${t("inputs.priceNeed", "Need")}</th>
      `;
      tbl.appendChild(thead);

      const keys = Object.keys(base);
      for (const item of keys) {
        const b = normalizeQuote(base[item]);
        const cur = normalizeQuote(ov[item] || b);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:6px 12px 6px 0;">${item}</td>
          <td style="padding:6px 12px 6px 0; text-align:right;">
            <input data-pt-item="${item}" data-pt-field="O" type="number" step="1" min="1"
                   value="${Number(cur.O)}" style="width:90px;" />
          </td>
          <td style="padding:6px 0 6px 0; text-align:right;">
            <input data-pt-item="${item}" data-pt-field="N" type="number" step="1" min="1"
                   value="${Number(cur.N)}" style="width:90px;" />
          </td>
        `;
        tbl.appendChild(tr);
      }

      // Remove any previous listener attached by prior renders
      if (tbl._ptOnEdit) {
        tbl.removeEventListener("input", tbl._ptOnEdit);
        tbl.removeEventListener("change", tbl._ptOnEdit);
      }

      const debounce = (fn, ms = 120) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      };

      const commit = debounce((target) => {
        const item = target.getAttribute("data-pt-item");
        if (!item) return;

        const phaseNow = els.phase.value;
        const baseNow = getPhasePriceTable(priceTable, phaseNow);
        const baseRow = normalizeQuote(baseNow[item]);

        const oInp = tbl.querySelector(`input[data-pt-item="${CSS.escape(item)}"][data-pt-field="O"]`);
        const nInp = tbl.querySelector(`input[data-pt-item="${CSS.escape(item)}"][data-pt-field="N"]`);

        const vO = parseInt(oInp?.value ?? "", 10);
        const vN = parseInt(nInp?.value ?? "", 10);

        const O = Number.isFinite(vO) && vO >= 1 ? vO : Number(baseRow.O);
        const N = Number.isFinite(vN) && vN >= 1 ? vN : Number(baseRow.N);

        const overrides = loadPriceOverrides(phaseNow);

        // If equals base, remove override
        const eqO = Number(O) === Number(baseRow.O);
        const eqN = Number(N) === Number(baseRow.N);
        if (eqO && eqN) {
          delete overrides[item];
        } else {
          overrides[item] = { O: Math.round(O), N: Math.round(N) };
        }

        savePriceOverrides(phaseNow, overrides);

        // Recalculate using the updated price table.
        calc();
      }, 120);

      const onEdit = (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement)) return;
        if (!target.matches('input[data-pt-item][data-pt-field]')) return;
        commit(target);
      };

      tbl._ptOnEdit = onEdit;
      tbl.addEventListener("input", onEdit);   // immediate while typing
      tbl.addEventListener("change", onEdit);  // fallback on blur
    }

    function readPositiveNumber(x, fallback) {
      const n = Number(x);
      return Number.isFinite(n) && n > 0 ? n : fallback;
    }

    function loadRuntimeOverridesIntoInputs() {
      // default to model-parameters.json values
      const tC = readPositiveNumber(localStorage.getItem(RT_KEYS.tC_min), Number(modelDefaults.tC_min));
      const tS = readPositiveNumber(localStorage.getItem(RT_KEYS.tS_min), Number(modelDefaults.tS_min));
      const tN = readPositiveNumber(localStorage.getItem(RT_KEYS.tN_min), Number(modelDefaults.tN_min));

      els.tC.value = String(tC);
      els.tS.value = String(tS);
      els.tN.value = String(tN);
    }

    function saveRuntimeOverridesFromInputs() {
      const tC = readPositiveNumber(els.tC.value, Number(modelDefaults.tC_min));
      const tS = readPositiveNumber(els.tS.value, Number(modelDefaults.tS_min));
      const tN = readPositiveNumber(els.tN.value, Number(modelDefaults.tN_min));

      localStorage.setItem(RT_KEYS.tC_min, String(tC));
      localStorage.setItem(RT_KEYS.tS_min, String(tS));
      localStorage.setItem(RT_KEYS.tN_min, String(tN));

      // normalize UI
      els.tC.value = String(tC);
      els.tS.value = String(tS);
      els.tN.value = String(tN);
    }

    function resetRuntimeOverrides() {
      localStorage.removeItem(RT_KEYS.tC_min);
      localStorage.removeItem(RT_KEYS.tS_min);
      localStorage.removeItem(RT_KEYS.tN_min);
      loadRuntimeOverridesIntoInputs();
    }

    function getParamsWithRuntimeOverrides() {
      // Start from defaults, then override times
      const params = { ...modelDefaults };
      params.tC_min = readPositiveNumber(els.tC.value, Number(modelDefaults.tC_min));
      params.tS_min = readPositiveNumber(els.tS.value, Number(modelDefaults.tS_min));
      params.tN_min = readPositiveNumber(els.tN.value, Number(modelDefaults.tN_min));
      return params;
    }

    function calc() {
      const phase = els.phase.value;
      localStorage.setItem("seasonPhase", phase);

      const rw = getSelectedRuneword();
      if (!rw) return;

      const effPriceTable = buildEffectivePriceTable(priceTable, phase);

      const b = renderRuneCost(rw, phase, effPriceTable);
      const costIst = Number(b.totalIst || 0);

      // If the total cost is below 1 Ist (including 0 due to unpriced low runes),
      // don't run the key pipeline planner.
      if (!(Number.isFinite(costIst)) || costIst < 1) {
        renderLowCostState();
        return;
      }

      const plan = planRotationToTargetIst({
        targetIst: costIst,
        phase,
        priceTable: effPriceTable,
        params: getParamsWithRuntimeOverrides(),
        tcDropTable,
        keyRuns,
        buffer: 1.0
      });

      renderPlan(plan);
      renderTradeList(plan);
      renderPredictedDrops(plan);
    }
    // init
    (async () => {
      await initI18n();

      priceTable = await loadPriceTable();
      runewordsData = await loadRunewords();
      modelDefaults = await loadModelDefaults();
      tcDropTable = await loadTcDropTable();
      keyRuns = await loadKeyRuns();

      // Phase must be set BEFORE rendering phase-dependent UI like the price table editor.
      setPhaseDefault();

      loadRuntimeOverridesIntoInputs();
      renderPriceEditor();
      renderRunewordOptions();

      // lang selector
      els.langSel.value = currentLang;
      els.langSel.addEventListener("change", () => applyLang(els.langSel.value, { rerender: true }));

      els.calc.addEventListener("click", calc);
      els.phase.addEventListener("change", () => { renderPriceEditor(); calc(); });
      els.rw.addEventListener("change", calc);
      els.q.addEventListener("input", () => { renderRunewordOptions(); calc(); });

      // runtime overrides
      const rtChanged = () => { saveRuntimeOverridesFromInputs(); calc(); };
      els.tC.addEventListener("change", rtChanged);
      els.tS.addEventListener("change", rtChanged);
      els.tN.addEventListener("change", rtChanged);
      els.resetTimes.addEventListener("click", () => { resetRuntimeOverrides(); calc(); });
      els.resetPrices.addEventListener("click", () => {
        const phase = els.phase.value;
        resetPriceOverrides(phase);
        renderPriceEditor();
        calc();
      });

      calc();
    })().catch((err) => {
      console.error(err);
      alert("Runewords Planner init failed. Open DevTools console for details.");
    });
  </script>
</body>
</html>
